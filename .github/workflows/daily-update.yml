name: Daily OSS Trend Update

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥åˆå‰9æ™‚ JST (UTC 0:00)
  workflow_dispatch:

permissions:
  contents: write
  issues: write

concurrency:
  group: daily-update
  cancel-in-progress: false

jobs:
  collect-trends:
    runs-on: ubuntu-latest
    name: Collect GitHub OSS Trends

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run trend tracker
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          python src/main.py

      - name: Cleanup old data files
        run: |
          python scripts/cleanup.py --retention-days 7

      - name: Configure Git user
        run: |
          git config --local user.name "oss-tracker-bot"
          git config --local user.email "bot@ossorbit.dev"

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Commit trend data
        run: |
          DATE=$(date +'%Y-%m-%d')
          git add data/ README.md
          git commit -m "chore: daily trend update ${DATE}" || echo "No changes to commit"
          
          git fetch origin master
          git pull --rebase origin master || {
            echo "Rebase failed, using merge..."
            git rebase --abort || true
            git pull origin master
          }
          
          git push origin HEAD:master

      - name: Create daily report issue
        if: github.event.schedule == '0 0 * * *'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = '${{ steps.date.outputs.date }}';
            const dataPath = `data/${date}.json`;
            
            let issueBody = `## æœ¬æ—¥ã®OSSãƒˆãƒ¬ãƒ³ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆ ${date}\n\n`;
            
            try {
              if (fs.existsSync(dataPath)) {
                const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
                issueBody += `### ğŸ“Š åé›†ãƒ‡ãƒ¼ã‚¿\n`;
                issueBody += `- ãƒˆãƒ¬ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªæ•°: ${data.trending?.length || 0}\n`;
                issueBody += `- æ›´æ–°æ™‚åˆ»: ${data.collected_at || 'N/A'}\n\n`;
                
                if (data.trending && data.trending.length > 0) {
                  issueBody += `### ğŸŒŸ ãƒˆãƒƒãƒ—5ãƒªãƒã‚¸ãƒˆãƒª\n`;
                  data.trending.slice(0, 5).forEach((repo, idx) => {
                    issueBody += `${idx + 1}. **${repo.name}** â­ ${repo.stars}\n`;
                  });
                }
              } else {
                issueBody += `ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n`;
              }
            } catch (error) {
              issueBody += `âš ï¸ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
            }
            
            issueBody += `\n---\n*è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ by GitHub Actions*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Daily Report] OSS Trends ${date}`,
              body: issueBody,
              labels: ['daily-report', 'automated']
            });

      - name: Upload trend data
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trend-data-${{ steps.date.outputs.date }}
          path: data/
          retention-days: 30
